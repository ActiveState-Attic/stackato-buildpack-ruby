#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e


# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

# use the latest ruby (1.9) in stackato
export PATH=/opt/rubies/current/bin:$PATH

function bundle_install {
    unset RUBYOPT BUNDLE_BIN_PATH GEM_PATH GEM_HOME BUNDLE_GEMFILE
    bundle install --path rubygems 
}

function write_database_yml {
    ruby "$ROOT_DIR/opt/write_database_yml.rb"
}

function db_migrate {
    rake db:migrate
}

cd $BUILD_DIR
bundle_install
write_database_yml
db_migrate
